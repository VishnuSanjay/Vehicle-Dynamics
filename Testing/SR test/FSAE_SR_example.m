data=[1	1	0	0	0
1	1	5	0.415401032	0.166159191
1	1	10	0.997004015	0.913912987
1	1	15	1.828058367	1.74493852
1	1	20	2.825846641	2.742669065
1	1	25	3.491496461	3.574733993
1	1	30	4.240920898	4.824302432
1	1	35	5.491641597	4.991072236
1	1	40	6.744990552	5.742081468
1	1	45	7.83383122	6.828655711
1	1	50	8.925523797	7.414731557
1	1	55	9.851803482	8.337309657
1	1	60	10.94987764	9.177902189
1	1	65	11.62761622	9.851803482
1	1	70	12.90291397	10.61159464
1	1	75	13.92781865	11.62761622
1	1	80	15.2154121	12.56222631
1	1	85	16.42428812	13.24406586
1	1	90	17.46645787	14.27044813
1	1	95	18.77765224	14.87131319
1	1	100	20.0106837	15.99171427
1	1	105	20.89733117	16.51091755
1	1	110	22.2372718	17.37938768
1	1	115	23.77155755	18.33949186
1	1	120	24.77396941	19.12900043
1	1	125	26.4321026	19.83395929
1	1	130	26.61778735	20.0991202
1	1	125	26.71074266	20.0106837
1	1	120	26.52490747	20.27614328
1	1	115	25.50808721	20.0106837
1	1	110	24.77396941	18.86542014
1	1	105	23.59013767	18.33949186
1	1	100	22.68673555	17.81515738
1	1	95	21.52109855	17.20537108
1	1	90	21.3426099	16.94465178
1	1	85	20.45336844	16.07815342
1	1	80	19.04109395	15.04329329
1	1	75	18.1645395	14.613599
1	1	70	17.03151781	14.09906913
1	1	64	15.90531244	13.32942801
1	1	60	15.04329329	12.90291397
1	1	55	14.35618639	11.96709832
1	1	50	12.81769908	10.94987764
1	1	45	11.79730481	10.18926449
1	1	40	10.69612988	9.262067961
1	1	35	9.683202948	8.337309657
1	1	30	8.6733197	7.582322324
1	1	25	7.414731557	6.577703344
1	1	20	6.494080924	5.742081468
1	1	15	5.491641597	5.074472934
1	1	10	4.407553784	3.991038419
1	1	5	3.491496461	3.325043329
1	1	0	2.4931703	2.4931703
1	1	-5	1.412494075	1.828058367
1	1	-10	0.415401032	0.747736518
1	1	-15	-0.415401032	0
1	1	-20	-1.246290368	-0.913912987
1	1	-25	-1.994309772	-1.828058367
1	1	-30	-2.992219835	-2.659497266
1	1	-35	-3.991038419	-3.408266299
1	1	-40	-4.824302432	-4.407553784
1	1	-45	-5.575109635	-5.157884401
1	1	-50	-6.494080924	-5.909102195
1	1	-55	-7.582322324	-6.912335487
1	1	-60	-8.505277881	-7.83383122
1	1	-65	-9.346253879	-8.589289494
1	1	-70	-10.10486624	-9.514686941
1	1	-75	-11.11916324	-10.61159464
1	1	-80	-12.13699844	-11.37327639
1	1	-85	-12.81769908	-12.22198901
1	1	-90	-13.92781865	-13.24406586
1	1	-95	-14.87131319	-14.09906913
1	1	-100	-15.47385454	-15.2154121
1	1	-105	-16.59758579	-16.33769723
1	1	-110	-17.29235883	-17.20537108
1	1	-115	-18.6022531	-18.33949186
1	1	-120	-19.21695366	-19.48109672
1	1	-125	-20.18760663	-20.45336844
1	1	-130	-20.45336844	-20.89733117
1	1	-125	-20.36473045	-20.63079806
1	1	-120	-20.45336844	-20.54205754
1	1	-115	-19.92229683	-20.36473045
1	1	-110	-19.74567081	-19.83395929
1	1	-105	-18.68992999	-18.42703431
1	1	-100	-17.98976205	-17.72791917
1	1	-95	-17.11842415	-16.77103967
1	1	-90	-15.99171427	-15.73261976
1	1	-85	-15.2154121	-15.04329329
1	1	-80	-14.78537457	-14.27044813
1	1	-75	-13.92781865	-13.58569602
1	1	-70	-12.98815788	-12.56222631
1	1	-65	-12.30700687	-11.62761622
1	1	-60	-11.45803087	-10.61159464
1	1	-55	-10.69612988	-10.10486624
1	1	-50	-9.76749255	-9.177902189
1	1	-45	-8.925523797	-8.253352663
1	1	-40	-8.253352663	-7.582322324
1	1	-35	-7.330960157	-6.828655711
1	1	-30	-6.410472381	-5.825585628
1	1	-25	-5.658589531	-4.991072236
1	1	-20	-4.824302432	-4.240920898
1	1	-15	-3.657979072	-3.574733993
1	1	-10	-3.075415805	-2.57633107
1	1	-4	-1.994309772	-1.578709659
1	1	0	-1.246290368	-1.080097138
1	1	5	-0.249239223	0
1	1	10	0.498483158	0.664650727
1	1	15	1.412494075	1.495600295
1	1	20	2.326864333	2.07744168
1	1	25	3.075415805	2.992219835
1	1	30	3.991038419	3.741231877
1	1	35	4.991072236	4.657573544
1	1	40	5.909102195	5.408185237
1	1	45	6.912335487	6.410472381
1	1	50	8.001587855	7.330960157
1	1	55	9.009630302	8.001587855
1	1	60	10.10486624	9.093756368
1	1	65	11.20384278	9.683202948
1	1	70	12.22198901	11.03450826
1	1	75	13.32942801	11.79730481
1	1	80	14.35618639	12.39205223
1	1	85	15.56007343	13.50024287
1	1	90	16.59758579	14.01342794
1	1	95	17.64072336	14.78537457
1	1	100	18.68992999	15.47385454
1	1	105	19.74567081	16.59758579
1	1	110	20.89733117	17.46645787
1	1	115	21.9682852	18.25199368
1	1	120	23.13767656	18.77765224
1	1	125	24.13515951	19.92229683
1	1	130	24.95708702	20.36473045
1	1	125	24.68251182	20.18760663
1	1	120	24.68251182	19.92229683
1	1	115	24.13515951	19.65743107
1	1	110	23.68081615	19.30495393
1	1	105	22.95712017	18.86542014
1	1	100	22.2372718	18.33949186
1	1	95	21.3426099	17.72791917
1	1	90	20.18760663	16.94465178
1	1	85	19.39300152	16.16463014
1	1	80	18.1645395	15.38767151
1	1	75	17.37938768	14.78537457
1	1	70	16.42428812	14.01342794
1	1	65	15.30152412	13.32942801
1	1	60	14.27044813	12.4771253
1	1	55	13.50024287	11.79730481
1	1	50	12.22198901	10.86527117
1	1	45	11.2885471	10.10486624
1	1	40	10.10486624	9.009630302
1	1	35	9.177902189	8.505277881
1	1	30	8.085491953	7.498518883
1	1	25	7.079739638	6.577703344
1	1	20	6.243296183	5.909102195
1	1	15	5.157884401	5.074472934
1	1	10	4.240920898	4.324232765
1	1	5	3.325043329	3.325043329
1	1	0	2.07744168	2.160577959];


SWANGL=data(:,3);
RFWA=data(:,4);
LFWA=data(:,5);

inx=find(abs(diff(SWANGL)) < 2.5);

SWANGL(inx)=[];
RFWA(inx)=[];
LFWA(inx)=[];



swa_l = SWANGL;
swa_r = SWANGL;

rwa   = RFWA;
lwa   = LFWA;

swa_ld=gradient(swa_l);
swa_rd=gradient(swa_r);

rwad=gradient(rwa);
lwad=gradient(lwa);

warning off;
sr_l=(swa_ld./lwad);
sr_r=(swa_rd./rwad);
warning on;


swa_l(find(isnan(sr_l)))=[];
sr_l(find(isnan(sr_l)))=[];
       
swa_r(find(isnan(sr_r)))=[];
sr_r(find(isnan(sr_r)))=[];

%--------------------- right wheel --------------------------------------
sr_r_fit  = sr_r (find(abs(swa_r) < 115));
swa_r_fit = swa_r(find(abs(swa_r) < 115));

options = optimset('MaxFunEvals',1000000,'MaxIter',1000000,'Display','final');

SR_R = [mean(sr_r_fit) 0 0 max(sr_r_fit) 0 0 270 0]  
[SR_R,x1,y1] = lsqcurvefit('sr_func',SR_R,swa_r_fit,sr_r_fit,[],[],options)

%-------------------- left wheel --------------------------------------
sr_l_fit  = sr_l (find(abs(swa_l) < 115));
swa_l_fit = swa_l(find(abs(swa_l) < 115));


SR_L = SR_R;    % go with a winner
SR_L(2)= -SR_L(2);  %flip sign of symetry term
%SR_L = [mean(sr_l_fit) 0 0 max(sr_l_fit) 0 0 260 0]  
[SR_L,x2,y2] = lsqcurvefit('sr_func',SR_L,swa_l_fit,sr_l_fit,[],[],options) 


sr_avg=(sr_l_fit+sr_r_fit)/2;
SR_AVG=(SR_L +SR_R)/2;

[SR_AVG,x3,y3] = lsqcurvefit('sr_func',SR_AVG,swa_l_fit,sr_avg,[],[],options) 

SR_NO_IS=SR_AVG
%--------------- Plot of fitted data ---------------------------
swaplot=-130:1:130;

F1=figure('Position',[100 100 800 600],'Color',[1. 1. 1.],'MenuBar','none','NumberTitle','off');
set(F1,'Name',['Steering Ratio Test Results   File: '])

subplot(2,1,1)
plot(swa_l,sr_l,'b'),hold on
plot(swa_r,sr_r,'r') 
%%plot(swaplot,sr_func(SR_L,swaplot),'g')
%%plot(swaplot,sr_func(SR_R,swaplot),'y')

axis([-150 150 3 15])
set(gca,'XTick',[-150:30:150]);

%%vref([-360 0 360])
%%title([PathName filename '   ' title4],'Interpreter','none')
legend('Raw CW Turns','Raw CCW Turns')

subplot(2,1,2)
%plot(swa_l_fit,sr_l_fit,'bo','markersize',2)
hold on
plot(swaplot,sr_func(SR_L,swaplot),'b-')

%plot(swa_r_fit,sr_r_fit,'ro','markersize',2)
hold on
plot(swaplot,sr_func(SR_R,swaplot),'r-')

%plot(swa_l_fit,sr_avg,'mo','markersize',2)
hold on
plot(swaplot,sr_func(SR_AVG,swaplot),'k-')
xlim([-150 150])
ylim([3 15])

%%vref([-360 -180 0 180 360]);
set(gca,'XTick',[-360:30:360]);

ax=axis;
text(-150,ax(4)+1.,{['Right:' num2str(SR_R,4)],['Left: ' num2str(SR_L,4)],['Avg. :' num2str(SR_AVG,4)]},'FontName','FixedWidth')
%%supertitle(['Overall Steer Ratio Test Results: '])
legend('Fitted CW Turns','Fitted CCW Turns','Avg Fitted')


F2=figure('Position',[100 100 800 600],'Color',[1. 1. 1.],'MenuBar','none','NumberTitle','off');
set(F2,'Name',['Steering Ratio Test Results   File: '])

plot(SWANGL,RFWA,SWANGL,LFWA)
grid
xlabel('Steering Wheel Angle (deg)')
ylabel('Road Wheel Angles (deg)')
%%href(0)
%%vref(0)
%%sidetext('BillCobb    zzvyb6@yahoo.com')
title('Like hell Im driving this again!')
